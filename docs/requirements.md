# FacialControl 要件定義書

## 文書情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | FacialControl |
| 文書バージョン | 2.0.0 |
| 作成日 | 2025-10-19 |
| 最終更新日 | 2026-02-02 |
| 作成者 | Hidano |

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|----------|
| 1.0.0-preview.1 | 2025-10-19 | Hidano | 初版作成 |
| 2.0.0 | 2026-02-02 | Hidano | QA シート（requirements-qa.md）の回答を元に全面改定 |

---

## 1. プロジェクト概要

### 1.1 目的

FacialControl は、3D キャラクターの表情をリアルタイムに制御する Unity 向けライブラリ（開発者向けアセット）である。OpenUPM でのパッケージ配布を想定する。

### 1.2 背景

ファンメイドライブプロジェクト「ミクノオト。」の開発過程で必要となった表情制御機能を、汎用ライブラリとして切り出すプロジェクト。

### 1.3 ユースケース

| 優先度 | ユースケース | 説明 |
|--------|-------------|------|
| メイン | VTuber 配信用フェイシャルキャプチャ連動 | 入力デバイスやネットワーク経由で受信した表情データを、リアルタイムに 3D キャラクターへ反映する |
| サブ | GUI エディタでの AnimationClip 作成支援 | Editor 上で BlendShape スライダーを操作しながら、表情の AnimationClip を効率的に作成する |

### 1.4 ターゲットユーザー

Unity エンジニア（開発者）。本プロジェクトはライブラリ（プラグイン）であるため、技術者向けの設計とする。

### 1.5 スコープ

**対象範囲**

- 表情プロファイルの管理（JSON / ScriptableObject）
- マルチレイヤーによるリアルタイム表情制御（Animator ベース）
- ブレンドシェイプ・ボーン・テクスチャ切り替え・UV アニメーションの統合制御
- 入力デバイス（コントローラ / キーボード）による表情切り替え
- OSC（UDP）による表情データのネットワーク送受信
- ARKit 52 / PerfectSync の自動検出・プロファイル自動生成
- Editor 拡張（プロファイル管理・AnimationClip 作成支援・JSON 入出力）
- 外部リップシンクプラグインとの連携インターフェース

**対象外**

- ランタイム UI の提供
- 音声解析・リップシンクエンジン
- 物理シミュレーション（クロス、髪の毛等）
- シェーダー・レンダリング品質の制御
- Web カメラによるフェイシャルキャプチャ（将来ロードマップ）
- VR ヘッドセットのフェイストラッキング（将来ロードマップ）
- VRM フォーマット対応（リリース後の早期マイルストーン）
- Timeline 統合（将来拡張）
- UnrealEngine / Blender / TouchDesigner 向けプラグイン（将来ロードマップ）

---

## 2. ステークホルダー

| 役割 | 名前 | 責任範囲 |
|------|------|----------|
| 主要開発者 | Hidano | 設計・実装・ドキュメント |
| レビュー・サポート | Junki Hiroi | コードレビュー・テスト |

---

## 3. 機能要件

### 3.1 機能要件一覧

| ID | 機能名 | 説明 |
|----|--------|------|
| FR-001 | 表情プロファイル管理 | 表情を「プロファイル」で抽象化し、JSON / ScriptableObject で永続化 |
| FR-002 | マルチレイヤー表情制御 | 複数レイヤーによる表情の同時適用・排他制御 |
| FR-003 | 表情遷移・補間 | 線形補間を基本とした表情間のスムーズな遷移 |
| FR-004 | OSC ネットワーク通信 | UDP + uOsc による VRChat 互換の表情データ送受信 |
| FR-005 | 入力デバイス制御 | InputSystem によるコントローラ / キーボードからの表情切り替え |
| FR-006 | ARKit / PerfectSync 対応 | ARKit 52 ブレンドシェイプ・PerfectSync の自動検出とプロファイル自動生成 |
| FR-007 | リップシンク連携 | 外部リップシンクプラグインからの入力受付インターフェース |
| FR-008 | Editor 拡張 | Inspector カスタマイズ、プロファイル管理ウィンドウ、AnimationClip 作成支援 |
| FR-009 | JSON インポート / エクスポート | プロファイルの JSON 形式での入出力 |

### 3.2 機能詳細

#### FR-001: 表情プロファイル管理

**概要**

表情を「プロファイル」として抽象化し、管理する機能。各プロファイルは複数の AnimationClip とメタデータを保持する。

**プロファイルの構成要素**

| 要素 | 説明 |
|------|------|
| 基本 AnimationClip | 目・眉等の BlendShape を含む表情の AnimationClip |
| カテゴリ属性 | 表情が属する部位カテゴリ（感情、口、目 等） |
| リップシンク用 AnimationClip | ブレンドして使用するリップシンク用の AnimationClip |
| 遷移時間 | 入力時の表情遷移にかける時間 |

**永続化方式**

- コア機能: JSON フォーマットで保存（Unity 以外の環境でも使用可能にするため）
- Unity 向けオプション: ScriptableObject Asset に変換して保存
- JSON → ScriptableObject 変換はランタイム機能として実装
- Asset ファイルへの保存のみ Editor ツールで実行
- ビルド後のアプリでも JSON で表情設定を差し替え可能

**JSON プロファイル仕様**

| 項目 | 仕様 |
|------|------|
| 後方互換性 | preview 段階では破壊的変更を許容。1.0.0 以降で互換性を担保 |
| スキーマ検証 | preview 段階では実装しない |

**デフォルトプリセット**

| プリセット | 説明 |
|-----------|------|
| デフォルト | 無操作時の基本表情。ニュートラルフェイスをユーザーがプロファイルで設定可能（モデルのデフォルトが意図しない表情の場合に上書き用） |
| まばたき | まばたき制御 |
| 目線操作 | ボーン制御 / BlendShape 制御の両方に対応。モデル構成に応じてユーザーが選択 |
| カメラ目線 | ボーン制御 / BlendShape 制御の両方に対応。モデル構成に応じてユーザーが選択 |

- プリセット数に依存しない設計とし、今後の追加を容易にする
- ユーザーカスタムプリセットの上限は暫定 512。ペイロード数を可変にし通信帯域を節約

---

#### FR-002: マルチレイヤー表情制御

**概要**

複数のレイヤーで表情を同時適用する仕組み。レイヤーごとに優先度と排他制御のモードを設定可能。

**デフォルトレイヤー構成**

| レイヤー | 優先度 | 説明 |
|---------|--------|------|
| 感情ベース | 最低 | 喜怒哀楽などの基本表情 |
| リップシンク | 中 | 口の動き（外部プラグインからの入力） |
| 目 | 高 | まばたき・目線操作 |

**排他制御**

- 同一カテゴリ内の排他モードは「後勝ち」と「ブレンド」から選択可能
- カテゴリごとに排他モードを設定できる
- レイヤー優先度はユーザーが設定可能（デフォルト優先度は提供する）

---

#### FR-003: 表情遷移・補間

**概要**

表情が切り替わる際のスムーズな遷移を提供する。

**補間方式**

| 項目 | 仕様 |
|------|------|
| デフォルト方式 | 線形補間 |
| カスタム方式 | イージング、任意のアニメーションカーブで上書き可能 |
| 遷移時間の範囲 | 0 秒（瞬時切り替え）〜 1 秒 |
| デフォルト遷移時間 | 0.25 秒 |

**遷移中の割り込み**

遷移中に新しい表情がトリガーされた場合:
1. 現在の遷移を即座に中断する
2. 現在の補間値（中間値）を起点として新しい遷移を開始する
3. 遷移時間は設定値通り一定

**テクスチャ・UV アニメーション**

- テクスチャ切り替えと UV アニメーションは AnimationClip 内のキーフレームとして定義
- FacialControl は AnimationClip を再生するだけで自動的に対応

---

#### FR-004: OSC ネットワーク通信

**概要**

UDP + uOsc を用いた VRChat 互換の OSC 通信による表情データの送受信。

**通信仕様**

| 項目 | 仕様 |
|------|------|
| プロトコル | UDP |
| ライブラリ | uOsc（FacialControl の必須依存として同梱） |
| OSC アドレスパターン | VRChat 完全互換（`/avatar/parameters/{name}` 形式） |
| 送信単位 | BlendShape 単位（各 BlendShape を個別の OSC メッセージで送受信） |
| データ型 | float (0-1) / int / bool（VRChat Avatar Parameters 仕様に準拠） |
| 送受信頻度 | 1 フレーム間に複数回送受信可能 |

**設計方針**

- プロファイルはローカル管理の概念。OSC 通信時にはプロファイル内の BlendShape 値に分解して送信
- OSC 以外の通信プロトコルもインターフェースで抽象化し、将来拡張可能にする
- UDP 送受信はメインスレッドに依存しない設計

---

#### FR-005: 入力デバイス制御

**概要**

Unity InputSystem による表情切り替え入力の管理。

**仕様**

| 項目 | 仕様 |
|------|------|
| 対応デバイス | ゲームコントローラ、キーボード |
| 入力方式 | ボタン / キーへのバインドで表情を切り替え |
| デフォルトバインディング | InputSystem の InputAction Asset を同梱 |
| カスタマイズ | InputAction Asset の差し替えで変更可能 |
| 抽象化 | 入力インターフェースを抽象化し、ユーザーが独自実装に差し替え可能 |

---

#### FR-006: ARKit / PerfectSync 対応

**概要**

ARKit 52 ブレンドシェイプおよび PerfectSync に対応したモデルの自動検出とプロファイル自動生成。

**仕様**

| 項目 | 仕様 |
|------|------|
| 対応範囲 | ARKit 52 ブレンドシェイプ + PerfectSync |
| 自動検出 | モデルが PerfectSync 対応であれば自動検出 |
| プロファイル自動生成 | 検出されたパラメータに基づきプロファイルを自動生成 |
| 未対応パラメータ | 警告なしでスキップ |
| リリース対応 | 初回プレリリースから完全対応 |

---

#### FR-007: リップシンク連携

**概要**

FacialControl はリップシンク用レイヤーの管理のみを提供する。音声解析は行わない。

**仕様**

- 外部リップシンクプラグイン（uLipSync 等）からの入力を受け付けるインターフェースを提供
- 外部から受け取った口の形（BlendShape 値）をリップシンクレイヤーに適用

---

#### FR-008: Editor 拡張

**概要**

UI Toolkit で実装する Editor 専用の拡張機能群。ランタイム UI は提供しない。

**機能一覧**

| 機能 | 説明 |
|------|------|
| Inspector カスタマイズ | プロファイル、ScriptableObject の編集 UI |
| 表情プロファイル管理ウィンドウ | EditorWindow による一覧表示、検索、プレビュー機能 |
| AnimationClip 作成支援ツール | 専用プレビューウィンドウ（Scene とは独立）で 3D モデルを表示し、BlendShape スライダーでリアルタイムプレビューしながら AnimationClip を作成 |
| JSON インポート / エクスポート | プロファイルの JSON 形式での入出力 |

---

#### FR-009: JSON インポート / エクスポート

**概要**

プロファイルデータの JSON 形式での入出力。

**仕様**

| 環境 | 保存形式 |
|------|----------|
| Unity Editor | ScriptableObject Asset と JSON の選択式 |
| スタンドアロン（ビルド後） | JSON のみ |

- AnimationClip としてのエクスポートは不要
- JSON 以外のフォーマットも不要

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 指標 | 基準 |
|------|------|
| GC アロケーション | 毎フレーム処理でゼロ目標 |
| 浮動小数点 | `float` 基本 |
| 表情遷移 | 線形補間 0〜1 秒対応 |
| ネットワーク | 1 フレーム間に複数回 UDP 送受信可能 |
| プリセット上限 | ユーザープリセット最大 512（ペイロード可変） |
| 同時キャラクター | 10 体以上の同時制御を想定 |
| 最適化戦略 | プレリリースは通常 C#。インターフェース設計で Jobs / Burst に差し替え可能 |
| JSON パース | パース負荷を抑えるデータ構造 |
| UDP 送受信 | メインスレッドに依存しない設計 |

### 4.2 対応プラットフォーム

| プラットフォーム | 対応状況 |
|----------------|----------|
| Windows PC | 対象（現行） |
| macOS / Linux | 将来拡張の余地を残す |
| Android / iOS | 将来拡張の余地を残す |
| WebGL | 将来拡張の余地を残す |
| VR | 将来拡張の余地を残す |

### 4.3 互換性

| 項目 | 仕様 |
|------|------|
| レンダーパイプライン | 非依存（URP / HDRP / Built-in いずれでも動作） |
| シェーダー | 非依存（lilToon 等は開発環境のみ） |
| 物理演算 | 非依存（MagicaCloth2 は開発環境のみ） |
| GPU | 非依存 |

### 4.4 対応モデルフォーマット

| フォーマット | 対応状況 |
|-------------|----------|
| FBX | プロトタイプから標準対応 |
| VRM | リリース後の早期マイルストーンで対応予定 |
| glTF | スコープ外 |

**ブレンドシェイプ仕様**

- 特定のブレンドシェイプ仕様には準拠しない（様々なモデルデータに対応するため）
- 命名規則は固定しない
- 2 バイト文字（日本語等）や特殊記号を正しく扱える実装が必要

### 4.5 テスト方針

| 項目 | 方針 |
|------|------|
| 開発手法 | TDD（Red-Green-Refactor）を厳密に遵守 |
| カバレッジ目標 | 数値目標は設定しない。TDD 運用で自然にカバレッジを確保 |
| ビジュアルリグレッション | 不要 |
| CI/CD | GitHub Actions + セルフホストランナー（Windows マシン） |

**テスト配置基準**

| 配置先 | 基準 | 例 |
|--------|------|-----|
| EditMode | モック・Fake のみ、同期実行、PlayMode 機能不要 | JSON パーステスト、プロファイル変換テスト |
| PlayMode | MonoBehaviour ライフサイクル、コルーチン、実 UDP/OSC 通信、フレーム同期が必要 | 表情遷移の補間テスト、OSC 送受信テスト |

### 4.6 エラーハンドリング

| 項目 | 方針 |
|------|------|
| ログ出力 | Unity 標準（Debug.Log / Debug.LogWarning / Debug.LogError）のみ |
| カスタムロガー | 実装しない |
| クラッシュレポート | 収集しない |
| エラー確認方法 | ユーザーは Unity Console で確認 |

---

## 5. アーキテクチャ

### 5.1 設計方針

クリーンアーキテクチャを採用。Domain / Application / Adapters / Presentation のレイヤー分離。Unity 依存を Adapters 層に封じ込める。

### 5.2 ディレクトリ構成

```
Runtime/
├── Domain/             # ドメインロジック（Unity 非依存）
├── Application/        # ユースケース
└── Adapters/           # Unity 依存の実装（JSON パーサー、OSC アダプター等）
Editor/                 # Editor 拡張（UI Toolkit）
Tests/
├── EditMode/           # PlayMode 不要なテスト
│   ├── Domain/
│   ├── Application/
│   └── Adapters/
├── PlayMode/           # PlayMode 必須なテスト
│   ├── Integration/
│   └── Performance/
└── Shared/             # EditMode / PlayMode 共用（Fakes 等）
```

各レイヤーは asmdef で依存方向を強制する。

### 5.3 表情制御方式

ブレンドシェイプ + ボーン + テクスチャ切り替え + UV アニメーションの組み合わせ。

| 制御方式 | 用途 |
|---------|------|
| ブレンドシェイプ | 表情の主要な変形（目、眉、口等） |
| ボーン | 目線操作等 |
| テクスチャ切り替え | AnimationClip 内のキーフレームとして定義 |
| UV アニメーション | AnimationClip 内のキーフレームとして定義 |

### 5.4 パッケージ情報

| 項目 | 値 |
|------|-----|
| パッケージ名 | `com.hidano.facialcontrol` |
| C# 名前空間 | `Hidano.FacialControl`（例: `Hidano.FacialControl.Domain`） |
| ライセンス | MIT |
| 配布先 | OpenUPM |
| uOsc | 必須依存パッケージとして同梱 |

---

## 6. 開発環境

| 項目 | 値 |
|------|-----|
| Unity バージョン | 6000.3.2f1 (Unity 6) |
| レンダリングパイプライン | URP v17.3.0（PC / モバイル別設定あり） |
| カラースペース | Linear |
| 入力システム | Input System v1.17.0 |
| テストフレームワーク | Unity Test Framework v1.6.0 |
| タイムライン | Timeline v1.8.9 |

**開発環境専用パッケージ（リリース非同梱）**

| パッケージ | 用途 |
|-----------|------|
| lilToon | トゥーンシェーダー（サンプルモデル用） |
| MagicaCloth2 | クロスシミュレーション（サンプルモデル用） |
| 初音ミクサンプルモデル | 開発・テスト用モデル |

---

## 7. リリース計画

### 7.1 リリース方式

機能単位で段階的にリリース: preview.1 → preview.2 → ... → 1.0.0

### 7.2 プレリリース（preview.1）スコープ

| 機能 | 対応状況 |
|------|----------|
| コア機能（プロファイル管理、表情遷移） | 含む |
| Editor 拡張（フルエディタ） | 含む |
| OSC 通信 | 含む |
| ARKit / PerfectSync 完全対応 | 含む |
| API ドキュメント | 含む |
| サンプルシーン | 含まない（別リポジトリまたは後のリリースで提供） |

### 7.3 目標スケジュール

- 2026 年 2 月末: プレリリース（preview.1）

### 7.4 将来ロードマップ

| 優先度 | 機能 |
|--------|------|
| 高 | VRM フォーマット対応 |
| 中 | Timeline 統合（カスタム Track / Clip） |
| 中 | Web カメラによるフェイシャルキャプチャ（ARKit / MediaPipe） |
| 中 | VR ヘッドセットのフェイストラッキング |
| 中 | 外部ソフトウェア連携（VSeeFace、iFacialMocap 等） |
| 低 | モバイル / WebGL / VR プラットフォーム対応 |
| 低 | VRoid Studio 対応 |
| 低 | UnrealEngine / Blender / TouchDesigner 向けプラグイン |

---

## 8. コーディング規約

### 8.1 基本ルール

| 項目 | 規約 |
|------|------|
| 言語 | C# |
| インデント | 4 スペース |
| 中括弧 | 改行して記述 |
| ドキュメント言語 | 日本語 |
| アクセス修飾子 | 明示的な `public` / `private` を推奨 |

### 8.2 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| クラス / 構造体 / enum | PascalCase | `FacialProfile` |
| インターフェース | `I` プレフィックス | `IFacialController` |
| プライベートフィールド | `_camelCase` | `_blendShapeWeight` |
| メソッド | PascalCase | `SetProfile` |

### 8.3 テスト命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| テストクラス | `{対象クラス}Tests` | `FacialProfileTests` |
| テストメソッド | `{メソッド}_{条件}_{期待結果}` | `SetProfile_ValidJson_ReturnsProfileWithCorrectBlendShapes` |

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| プロファイル | 表情を抽象化した単位。基本 AnimationClip、カテゴリ属性、リップシンク用 AnimationClip、遷移時間を保持する |
| レイヤー | 表情制御の優先度階層。複数レイヤーの同時適用で最終的な表情が決まる |
| プリセット | 事前定義された表情プロファイルの設定 |
| カテゴリ | 表情が属する部位分類（感情、口、目 等）。排他制御の単位 |
| ブレンドシェイプ | 3D メッシュの変形ターゲット（モーフターゲット）。表情の主要な表現手段 |
| ARKit 52 | Apple の ARKit が定義する 52 種類の顔のブレンドシェイプ |
| PerfectSync | ARKit 52 を拡張した VRChat 向けの表情パラメータ仕様 |
| OSC | Open Sound Control。UDP ベースの通信プロトコル |
| uOsc | Unity 向け OSC 通信ライブラリ |
| InputAction Asset | Unity InputSystem の入力バインディング定義ファイル |

---

## 10. 参考資料

| 資料 | 場所 |
|------|------|
| QA シート | `docs/requirements-qa.md` |
| CLAUDE.md | `CLAUDE.md` |
| Copilot 指示 | `.github/copilot-instructions.md` |
